# 用户头像上传功能 - 需求文档

## 文档信息

| 属性 | 值 |
|------|-----|
| 文档编号 | REQ-003 |
| 版本 | v1.0 |
| 创建日期 | 2026-01-10 |
| 最后更新 | 2026-01-15 |
| 作者 | Jem |
| 状态 | 已实现 |

---

## 1. 功能概述

### 1.1 简要描述

允许用户上传和更换个人头像，支持图片裁剪和多种格式。

### 1.2 关键词

用户头像、图片上传、图片裁剪、文件存储、CDN

---

## 2. 背景和目标

### 2.1 背景

当前系统使用默认头像，用户无法自定义个人形象。为提升用户体验和社区互动感，需要支持用户自定义头像功能。

### 2.2 目标

- 目标 1：用户可以上传本地图片作为头像
- 目标 2：提供图片裁剪功能，确保头像为正方形
- 目标 3：头像文件通过 CDN 分发，确保加载速度

### 2.3 非目标

- 不支持动态 GIF 头像
- 不支持头像审核功能（一期）
- 不支持第三方头像（如 Gravatar）集成

---

## 3. 功能需求

### 3.1 用户故事

| 编号 | 角色 | 需求 | 价值 |
|------|------|------|------|
| US-01 | 作为普通用户 | 我希望上传自己的照片作为头像 | 以便展示个人形象 |
| US-02 | 作为普通用户 | 我希望裁剪上传的图片 | 以便选择最合适的区域 |
| US-03 | 作为普通用户 | 我希望预览头像效果 | 以便确认是否满意 |

### 3.2 功能清单

| 编号 | 功能名称 | 优先级 | 描述 |
|------|----------|--------|------|
| F-01 | 图片上传 | P0 | 支持 JPG、PNG、WebP 格式，最大 5MB |
| F-02 | 图片裁剪 | P0 | 提供可视化裁剪工具，输出 200x200 像素 |
| F-03 | 实时预览 | P1 | 上传和裁剪时显示效果预览 |
| F-04 | 头像删除 | P2 | 允许用户删除头像，恢复默认 |

### 3.3 业务规则

- BR-01：上传的图片必须是有效的图片文件
- BR-02：图片文件大小不超过 5MB
- BR-03：裁剪后的头像统一为 200x200 像素
- BR-04：头像文件存储在 OSS，通过 CDN 分发

---

## 4. 非功能需求

### 4.1 性能要求

- 响应时间：图片上传完成后 2 秒内返回结果
- 吞吐量：支持每秒 100 次并发上传

### 4.2 安全要求

- 对上传文件进行类型验证，防止恶意文件
- 使用随机文件名，防止路径遍历
- 限制上传频率，防止滥用

### 4.3 兼容性

- 浏览器：Chrome 80+、Firefox 75+、Safari 13+、Edge 80+
- 移动端：iOS Safari、Android Chrome

---

## 5. UI/交互设计

### 5.1 页面布局

```
┌─────────────────────────────────────┐
│  个人设置                            │
├─────────────────────────────────────┤
│                                     │
│   ┌─────────┐   当前头像            │
│   │         │   用户名: admin       │
│   │ [头像]  │                       │
│   │         │   [更换头像] [删除]   │
│   └─────────┘                       │
│                                     │
└─────────────────────────────────────┘
```

### 5.2 交互流程

1. 用户点击「更换头像」按钮
2. 弹出文件选择对话框
3. 用户选择本地图片
4. 显示图片裁剪界面
5. 用户拖动选择裁剪区域
6. 点击「确认」按钮
7. 显示上传进度
8. 上传完成，更新页面头像

### 5.3 状态说明

| 状态 | 显示效果 | 触发条件 |
|------|----------|----------|
| 默认 | 显示默认头像 | 用户未上传头像 |
| 裁剪中 | 显示裁剪对话框 | 选择图片后 |
| 上传中 | 显示进度条 | 点击确认后 |
| 成功 | 显示新头像 + 提示 | 上传完成 |
| 失败 | 显示错误提示 | 上传出错 |

---

## 6. 数据模型

### 6.1 用户表变更

在 `users` 表添加头像字段：

| 字段名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| avatar | VARCHAR(500) | 否 | 头像 URL |
| avatar_updated_at | DATETIME | 否 | 头像更新时间 |

### 6.2 文件存储

头像文件存储路径格式：
```
avatars/{user_id}/{timestamp}_{random}.{ext}
```

示例：
```
avatars/12345/1705312000_a1b2c3.jpg
```

---

## 7. 验收标准

### 7.1 功能验收

- [x] AC-01：用户可以成功上传 JPG 格式图片
- [x] AC-02：用户可以成功上传 PNG 格式图片
- [x] AC-03：超过 5MB 的图片显示错误提示
- [x] AC-04：裁剪功能正常工作
- [x] AC-05：上传成功后页面头像立即更新
- [x] AC-06：删除头像后恢复默认头像

### 7.2 测试用例

| 用例编号 | 描述 | 预期结果 |
|----------|------|----------|
| TC-01 | 上传 1MB JPG 图片 | 上传成功，头像更新 |
| TC-02 | 上传 10MB PNG 图片 | 显示"文件过大"错误 |
| TC-03 | 上传 TXT 文件 | 显示"格式不支持"错误 |
| TC-04 | 裁剪并上传 | 头像为裁剪后的区域 |
| TC-05 | 取消裁剪 | 返回原界面，无变化 |
| TC-06 | 删除已有头像 | 恢复默认头像 |

---

## 8. 时间节点

| 里程碑 | 计划日期 | 实际日期 | 状态 |
|--------|----------|----------|------|
| 需求评审 | 2026-01-10 | 2026-01-10 | 已完成 |
| 开发完成 | 2026-01-13 | 2026-01-13 | 已完成 |
| 测试完成 | 2026-01-14 | 2026-01-14 | 已完成 |
| 上线发布 | 2026-01-15 | 2026-01-15 | 已完成 |

---

## 附录

### A. 相关文档

- [API 文档](../api/API.md)
- [架构文档](../architecture.md)
- [文件存储方案](../architecture/storage.md)

### B. 变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0 | 2026-01-10 | Jem | 初始版本 |

### C. 技术备注

- 前端使用 [vue-cropper](https://github.com/xyxiao001/vue-cropper) 组件
- 后端使用 Pillow 库进行图片处理
- 文件存储使用阿里云 OSS
